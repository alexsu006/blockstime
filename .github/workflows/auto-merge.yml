name: Auto Merge Claude Code PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest

    # 只处理 Claude Code 创建的 PR（分支名以 claude/ 开头）
    if: startsWith(github.event.pull_request.head.ref, 'claude/') && github.event.pull_request.user.login == 'alexsu006'

    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      # 自动合并 PR
      - name: Merge Pull Request
        run: |
          # 先尝试直接合并
          if gh pr merge ${{ github.event.pull_request.number }} --squash --auto; then
            echo "✅ PR #${{ github.event.pull_request.number }} 已设置为自动合并"
            echo "如果有必需的检查，PR 将在检查通过后自动合并"
            echo "如果没有必需检查，PR 将立即合并"
          else
            echo "⚠️ 无法启用自动合并，可能是因为分支保护设置"
            echo "尝试直接合并..."
            gh pr merge ${{ github.event.pull_request.number }} --squash || echo "❌ 合并失败，请检查分支保护规则"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Success message
        run: |
          echo "✅ PR #${{ github.event.pull_request.number }} 处理完成"
          echo "已自动尝试合并"
